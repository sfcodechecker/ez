<apex:page showHeader="false" sidebar="false" standardStylesheets="false" applyHtmlTag="false" applyBodyTag="false" docType="html-5.0"
           controller="BPointCheckoutPageController">
    <apex:outputPanel id="renderPanel" rendered="{!errorMessage == '' || errorMessage == null}">
        
        <div class="overlay" style="display: block;" id="spinner">
            <div class="overlay__wrapper">
                <div class="overlay__spinner"></div>
            </div>
            <p class="wait" style="Text-align : center; font-size: 22px;font-weight: 600;margin-top: -44%; color: gainsboro;" >Please wait do not close.</p>
        </div>
        
        <html lang="en">
            <head>
                <title>Bpoint Payments | EzyCharge</title>
                <meta charset="utf-8(ampersand, U+0026)" />
                <meta name="viewport" content="width=device-width, initial-scale=1" />
                
                <apex:stylesheet value="{!URLFOR($Resource.Payments,'/css/BpointCheckout.css')}"/>
                <apex:stylesheet value="{!URLFOR($Resource.Payments,'/css/v4.0.0bootstrap.min.css')}"/>
                <apex:stylesheet value="{!URLFOR($Resource.Payments,'/css/font.css')}"/>
                <apex:stylesheet value="{!URLFOR($Resource.Payments,'/css/style.css')}"/>
            </head>
            <body>
                <main class="page payment-page" id="mainform">
                    <section class="payment-form dark">
                        <div class="container">
                            <form id="payform">
                                <apex:outputPanel id="theOneTimePanel" layout="block" rendered="{!charge_type == 'OneTime'}" >
                                    <div class="products">
                                        <div class="container text-center">
                                            <apex:image alt="BPoint Pty Ltd" url="{!URLFOR($Resource.Payments,'logos/BPointLogo.png')}" width="20%" height="20%"/>
                                        </div>
                                        <h3 class="title">Checkout Details</h3>
                                        <div class="item">
                                            <div style="{!IF(Name != null, 'display:block', 'display:none')}">
                                                <span class="price"> :&nbsp;&nbsp;&nbsp;{!HTMLENCODE(Name)}</span>
                                                <p class="item-name">Name</p>
                                            </div>
                                            <div style="{!IF(email != null, 'display:block', 'display:none')}">
                                                <span class="price"> :&nbsp;&nbsp;&nbsp;{!HTMLENCODE(email)}</span>
                                                <p class="item-name">Email</p>
                                            </div>
                                            <div style="{!IF(amount != null, 'display:block', 'display:none')}">
                                                <span class="price"> :&nbsp;&nbsp;&nbsp;${!HTMLENCODE(showAmount)} (AUD)</span>
                                                <p class="item-name">Amount</p>
                                            </div>
                                        </div>
                                    </div>
                                </apex:outputPanel>
                                <apex:outputPanel id="theRecurringPanel" layout="block" rendered="{!charge_type == 'Recurring'}" >
                                    <div class="products">
                                        <div class="container text-center">
                                            <apex:image alt="BPoint Pty Ltd" url="{!URLFOR($Resource.Payments,'logos/BPointLogo.png')}" width="22%" height="22%"/>
                                        </div>
                                        <h3 class="title">Checkout Details</h3>
                                        <div class="item">
                                            <div style="{!IF(Name != null, 'display:block', 'display:none')}">
                                                <span class="price"> :&nbsp;&nbsp;&nbsp;{!HTMLENCODE(Name)}</span>
                                                <p class="item-name">Name</p>
                                            </div>
                                            <div style="{!IF(email != null, 'display:block', 'display:none')}">
                                                <span class="price" id="emailvalue"> : &nbsp; {!HTMLENCODE(email)}</span>
                                                <p class="item-name">Email </p>
                                            </div>
                                            <div style="{!IF(amount != null, 'display:block', 'display:none')}">
                                                <span class="price"> :&nbsp;&nbsp;&nbsp;${!HTMLENCODE(showAmount)} (AUD)</span>
                                                <p class="item-name">Regular Amount </p>
                                            </div>
                                            <div style="{!IF(paymentDate != null, 'display:block', 'display:none')}">    
                                                <span class="price"> :&nbsp;&nbsp;&nbsp;{!HTMLENCODE(paymentDate)}</span>
                                                <p class="item-name">First Installment Date </p>
                                            </div>
                                            <div style="{!IF(frequency != null, 'display:block', 'display:none')}">
                                                <span class="price"> :&nbsp;&nbsp;&nbsp;{!HTMLENCODE(frequency)}</span>
                                                <p class="item-name">Installment Period</p>
                                            </div>
                                        </div>
                                    </div>
                                </apex:outputPanel>
                                <div class="products">
                                    <h3 class="title">Credit Card Details</h3>
                                    <!-- Iframe section start -->
                                    <div class="iframe">
                                        <div id="pay-form-location">
                                        </div>
                                        <apex:form >
                                            <apex:actionFunction name="callCompleteTransaction" action="{!completeTransaction}" reRender="renderPanel">
                                                <apex:param id="respFromBpoint" name="transRespose" value="" />
                                            </apex:actionFunction>
                                        </apex:form>
                                        <apex:includeScript value="{!URLFOR($Resource.Payments, 'JS/jquery-3.6.0.min.js')}" />
                                        <apex:includeScript value="{!URLFOR($Resource.Payments, 'JS/BPoint_api.js')}" />
                                    </div>
                                    <!-- Iframe section end -->
                                    <br/>
                                    <br/>
                                    <br/>
                                    <br/>
                                    <br/>
                                    <br/>
                                </div>
                            </form>
                        </div>
                    </section>
                </main> <br/>
                
            </body>
            <script>
            
            window.addEventListener('load', function () {
                document.getElementById('spinner').style.display = 'none';
            }, false);

            var referenceId='{!JSENCODE(referenceId)}';
            //Change GatewayPostCheckout with Q_Charge__BPointSomethingWentWrong when demo done
            CBA.SetupPayment({
                AppendToElementId: "pay-form-location",
                AuthKey: "{!JSENCODE('df998fea-f309-4e6e-9629-7149799dc028')}",
                DefaultErrorUrl: "{!$Site.BaseUrl}/apex/GatewayPostCheckout?reference="+referenceId+"&amount={!JSENCODE(paymentAmount)}", 
                Amount: {
                    Visible: false,
                    LabelName: "Amount",
                    ReadOnly: true,
                    value: 10,
                },
            });
            
            document.getElementById("api-submitbutton").value = '{!JSENCODE(buttonname)}';
            
            document.getElementById("api-submitbutton").addEventListener("click", resetButtonName);

            function resetButtonName(){
                document.getElementById("api-submitbutton").value = '{!JSENCODE(buttonname)}';
            }
            
            //document.getElementById('api-amount').value = '{!JSENCODE(paymentAmount)}';
            function ProcessPaymentCallBack(result) {
                //document.getElementById("api-submitbutton").value = '{!JSENCODE(buttonname)}';+
                document.getElementById('spinner').style.display = 'none';
                var errors = new Array();
                if (result.AjaxResponseType == 0) {
                    //AJAX call was successful
                    if (result.ApiResponseCode == 0) {
                        //API returned success.
                        //Refer to (API Response Codes) for API Response codes.
                        //Submit result.ResultKey to your server for further
                        //processing (Refer Transaction Result)
                        callCompleteTransaction(result);
                        window.close();
                    }
                    else if (result.ApiResponseCode == 300) {
                        if (result.RedirectionUrl != null && result.RedirectionUrl.length > 0)
                            window.location.href = result.RedirectionUrl;
                        else
                            errors = result.Errors;
                    }
                        else {
                            errors = result.Errors;
                        }
                }
                else if (result.AjaxResponseType == 1) {
                    //Error with AJAX call
                    errors = result.Errors;
                }
                    else if (result.AjaxResponseType == 2) {
                        //AJAX call timed out
                        errors = result.Errors;
                    }
                
                //Show errors on the page
                if (errors.length > 0) {
                    var ul = $("<ul></ul>");
                    $.each(errors, function (i, r) {
                        ul.append("<li>" + r.Message + "</li>");
                    });
                    $(".validation-summary").append(ul).show();
                }
            }    
            </script>
        </html>
    </apex:outputPanel>
</apex:page>