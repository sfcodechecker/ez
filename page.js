function setDefaults(){$.validator.setDefaults({highlight:function(e){var r=$(e).closest(".form-group"),a=$(e).prop("id");r.data(a,!1),$(".successful").empty(),$(".successful").hide(),$(e).closest(".form-group").addClass("has-error")},unhighlight:function(e){var r=!0,a=$(e).closest(".form-group"),t=$(e).prop("id");a.data(t,!0),a.find(":input").each(function(){a.data($(this).prop("id"))===!1&&(r=!1)}),r&&a.removeClass("has-error")},errorElement:"span",errorClass:"help-block",errorPlacement:function(e,r){r.parent(".input-group").length?e.insertAfter(r.parent()):e.insertAfter(r)}})}function displayError(e){"undefined"==typeof e&&(e="An error has occurred while submitting your payment details."),showErrorModal("Error",e),$(".mustAgree").change()}function setupFormValidation(){$.validator.addMethod("isNumeric",function(e){var r=/^([0-9\s])+$/;return r.test(e)},"Invalid credit card number"),$.validator.addMethod("validCardType",function(e){var r=GetCardType(e);return"Visa"===r||"MasterCard"===r},"Only Visa or Mastercards are accepted"),$.validator.addMethod("validCardNumber",function(e){var r=GetCardType(e);return checkCreditCard(e,r)},"Invalid credit card number"),$.validator.addMethod("validNameOnCard",function(e){var r=/^[A-Za-z0-9\.,'&\s]*$/;return r.test(e)},"Invalid name on card"),$.validator.addMethod("isCardCurrent",function(){var e=new Date;return!(null!==$("#expiryYear").val()&&toNumber($("#expiryYear").val())<=e.getFullYear()&&null!==$("#expiryMonth").val()&&toNumber($("#expiryMonth").val())<e.getMonth()+1)},"Expiry date is set in the past"),$.validator.addMethod("validateExpiryMonth",function(){return $("#expiryMonth").valid(),!0},""),$.validator.addMethod("isValidBSB",function(e){var r=/^[0-9]{3}[\-]?[0-9]{3}$/;return r.test(e.replace(/\s/g,""))},"Invalid BSB number"),$.validator.addMethod("BSBexists",function(e){var r=e.replace(/\s|\-/g,""),a=$("#username").val(),t="validateBSB/"+r+"?clientUsername="+a,d=ajaxRequestSync("GET",t,null),i=""!=d.bankName&&""!=d.branchName;return i?($("#bsbDetails").html('<p class="help-block"><span class="glyphicon glyphicon-ok"></span> '+$.trim(d.bankName)+" - "+$.trim(d.branchName)+"</p>"),$("#bsbDetails").show()):($("#bsbDetails").empty(),$("#bsbDetails").hide()),i},"Invalid BSB number"),$.validator.addMethod("isValidAccountNumber",function(e){var r=/^[0-9]+$/;return r.test(e.replace(/\s/g,""))},"Invalid account number"),$.validator.addMethod("isValidAccountName",function(e){var r=/^[A-Za-z0-9\.,'&\s]*$/;return r.test(e)},"Invalid account name"),$("#setUpPaymentForm").validate({debug:!0,focusInvalid:!1,focusCleanup:!0,submitHandler:function(e){var r={contentType:"application/json",success:function(e){if(0===e.returncode)$("#setUpPaymentForm").fadeOut("slow",function(){$("#successMessage").fadeIn("slow"),$("#setUpPaymentForm").remove()});else if(2===e.returncode){displayError("Provided BSB number is invalid.");var r=$.data($("#setUpPaymentForm")[0],"validator");r.showErrors({bsb:"Provided BSB number is invalid"})}else jQuery.inArray(e.returncode,new Array(996))!=-1?displayError(e.returnmessage):displayError()},error:function(){displayError()}};$('[type="submit"]').addClass("disabled"),$('[type="submit"]').prop("disabled","disabled"),submitForm(e,r)},invalidHandler:function(e,r){r.numberOfInvalids();$(".mustAgree").change()},rules:{bsb:{required:isBankAccount,isValidBSB:isBankAccount,BSBexists:isBankAccount},accountNumber:{required:isBankAccount,isValidAccountNumber:isBankAccount},accountName:{required:isBankAccount,isValidAccountName:isBankAccount},cardNumber:{required:isCreditCard,isNumeric:isCreditCard,validCardType:isCreditCard,validCardNumber:isCreditCard},nameOnCard:{required:isCreditCard,validNameOnCard:isCreditCard},expiryMonth:{required:isCreditCard,isCardCurrent:isCreditCard},expiryYear:{required:isCreditCard,validateExpiryMonth:isCreditCard}},messages:{bsb:{required:"BSB number is required"},accountNumber:{required:"Account number is required"},accountName:{required:"Account name is required"},cardNumber:{required:"A credit card number is required"},nameOnCard:{required:"Credit card holder's name is required"},expiryMonth:{required:"Credit card expiry month is required"},expiryYear:{required:"Credit card expiry year is required"}}})}function isCreditCard(){return"Credit Card"===$('[name="paymentMethodType"]:checked').val()}function isBankAccount(){return"Bank Account"===$('[name="paymentMethodType"]:checked').val()}function validateCardNumber(){var e=$("#cardNumber").val(),r=GetCardType(e);"Invalid"===r||"Visa"!==r&&"MasterCard"!==r||!checkCreditCard(e,r)?$("#cardNumber").css("background",""):"Visa"===r?$("#cardNumber").css("background","url('assets/img/card_validation_visa.gif') no-repeat right center"):"MasterCard"===r&&$("#cardNumber").css("background","url('assets/img/card_validation_mastercard.gif') no-repeat right center")}$(document).ready(function(){$('[name="paymentMethodType"]').change(function(e){$(":input","form").not(':button, :submit, :reset, :hidden, :disabled, [name="paymentMethodType"], :checkbox').val("").removeAttr("selected"),$("select option:first-child").attr("selected","selected"),$('[name="paymentMethodType"]').prop("disabled","disabled"),"Bank Account"===$(e.currentTarget).val()?$("#paymentMethodCreditCard").fadeOut("default",function(){$("#setUpPaymentForm .has-error").removeClass("has-error"),$("#setUpPaymentForm").valid(),$("#paymentMethodBankAccount").fadeIn("default",function(){$('[name="paymentMethodType"]').prop("disabled","")})}):$("#paymentMethodBankAccount").fadeOut("default",function(){$("#setUpPaymentForm .has-error").removeClass("has-error"),$("#setUpPaymentForm").valid(),$("#paymentMethodCreditCard").fadeIn("default",function(){$('[name="paymentMethodType"]').prop("disabled","")})})}),$("#cardNumber").keyup(validateCardNumber),$("#cardNumber").focusout(validateCardNumber),$("#expiryYear").change(function(){$("#expiryMonth").click()}),$('[name="paymentMethodType"]').length>0&&$("#paymentMethodBankAccount").hide(),setDefaults(),setupFormValidation()});